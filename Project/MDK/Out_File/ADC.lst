C251 COMPILER V5.60.0,  ADC                                                                05/04/25  21:33:17  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE ADC
OBJECT MODULE PLACED IN .\Out_File\ADC.obj
COMPILER INVOKED BY: d:\Keil_v5\C251\BIN\C251.EXE ..\USER\src\ADC.c XSMALL INTR2 WARNINGLEVEL(3) BROWSE INCDIR(..\..\Lib
                    -raries\libraries;..\..\Libraries\seekfree_libraries;..\..\Libraries\seekfree_peripheral;..\CODE;..\USER\inc;..\USER\src)
                    - DEBUG PRINT(.\Out_File\ADC.lst) OBJECT(.\Out_File\ADC.obj) 

stmt  level    source

    1          #include "ADC.h"
    2          #include "math.h"
    3          // int16 aim_speeda        = 730;  //ç›®æ ‡é€Ÿåº¦
    4          int16 aim_speedb;               // è¾“å‡ºé€Ÿåº¦ï¼ˆåŠ¨æ€æœŸæœ›é€Ÿåº¦ï¼‰=æœŸæœ›é€Ÿåº¦*æœŸæœ›å‡é€Ÿåº¦
    5          int16 aim_speedc = 760; // è½¬å¼¯å‡å°é€Ÿåº¦
    6          float errorh = 0;
    7          float errors = 0;
    8          float errors1 = 0;
    9          
   10          int16 adc_value[4]; // å‚¨å­˜ç”µæ„Ÿé‡‡é›†å€¼åŸå§‹å€¼    4ä¸ªç”µæ„Ÿ
   11          int16 AD_V[4];          // å‚¨å­˜ç”µæ„Ÿé‡‡é›†å€¼å½’ä¸€åŒ–å€¼ä¸­é—´å˜é‡ ï¼ˆæ— éœ€å…³å¿ƒï¼Œè¯·å‹¿åˆ é™¤ï¼‰
   12          // int16 adc_max[4]={90,90,90,95}; //ç”µæ„Ÿé‡‡å€¼æœ€å¤§å€¼ éœ€è¦è‡ªå·±é‡‡é›†
   13          int16 adc_max[4] = {200, 200, 200, 200};                                // ç”µæ„Ÿé‡‡å€¼æœ€å¤§å€¼ éœ€è¦è‡ªå·±é‡‡é›†
   14          int16 adc_min[4] = {1, 1, 1, 1};                                                // ç”µæ„Ÿé‡‡å€¼æœ€å°å€¼  1,4,14,1
   15          uint8 Left_Adc, Right_Adc, Left_Shu_Adc, Right_Shu_Adc; // ç”µæ„Ÿå€¼
   16          float adc_valueM;
   17          int8 NM = 4; // ç”µæ„Ÿä¸ªæ•°
   18          
   19          // ç¯é“å‚æ•°
   20          uint16 annulus_s = 0;  // ç¯å²›ç§¯åˆ†è·ç¦»
   21          uint16 annulus_s2 = 0; // ç¯å²›ç§¯åˆ†è·ç¦»2
   22          uint16 annulus_s3 = 0;
   23          uint16 annulus_z = 0; // ç¯å²›ç¬¬ç§¯åˆ†æ‰“è§’
   24          uint16 annulus_t = 0;
   25          uint16 annulus_post = 0; // å‡ºç¯åç›´èµ°ç§¯åˆ†è·ç¦»
   26          
   27          uint16 obstacle_annulus_z1 = 0;
   28          uint16 obstacle_annulus_s1 = 0;
   29          uint16 obstacle_annulus_z2 = 0;
   30          uint16 obstacle_annulus_s2 = 0;
   31          uint16 obstacle_annulus_z3 = 0;
   32          uint16 obstacle_annulus_s3 = 0;
   33          uint8 obstacle_switch_1 = 0;
   34          uint8 obstacle_switch_2 = 0;
   35          uint8 obstacle_switch_3 = 0;
   36          uint8 obstacle_switch_4 = 0;
   37          
   38          struct ROAD_TYPE road_type = {0};
   39          int16 obstacle_Current_Dir[] = {
   40                  30,
   41                  31,
   42                  32,
   43                  33,
   44                  34,
   45                  35,
   46                  36,
   47                  37,
   48                  38,
   49                  39,
   50                  40,
   51                  41,
   52                  42,
   53                  43,
   54                  44,
   55                  45,
   56                  46,
   57                  47,
C251 COMPILER V5.60.0,  ADC                                                                05/04/25  21:33:17  PAGE 2   

   58                  48,
   59                  49,
   60                  -69,
   61                  -68,
   62                  -67,
   63                  -66,
   64                  -65,
   65                  -64,
   66                  -63,
   67                  -62,
   68                  -61,
   69                  -60,
   70                  -59,
   71                  -58,
   72                  -57,
   73                  -56,
   74                  -55,
   75                  -54,
   76                  -53,
   77                  -52,
   78                  -51,
   79                  -50,
   80                  -49,
   81                  -48,
   82                  -47,
   83                  -46,
   84                  -45,
   85                  -44,
   86                  -43,
   87                  -42,
   88                  -41,
   89                  -40,
   90                  -39,
   91                  -38,
   92                  -37,
   93                  -36,
   94                  -35,
   95                  -34,
   96                  -33,
   97                  -32,
   98                  -31,
   99                  -30,
  100          };
  101          /***å½“å‰ä½ç½®*************/
  102          float Current_Dir = 0;
  103          int16 Set_gyro = 0;
  104          int16 ADC_PWM = 0;
  105          uint8 flag_obstacle = 0;
  106          uint16 obstacle_time = 0;
  107          uint8 temp = 0;
  108          int16 testflag = 0;
  109          /***************************ç”µæ„Ÿé‡‡é›†é€šé“åˆå§‹åŒ–****************************
  110          å‡½æ•°ï¼š  void ADC_int(void)
  111          åŠŸèƒ½ï¼š  ç”µæ„Ÿé‡‡å€¼è¿›è¡Œåˆå§‹åŒ–
  112          å‚æ•°ï¼š  void
  113          è¯´æ˜ï¼š  ç”µæ„Ÿé‡‡é›†åˆå§‹åŒ–
  114          è¿”å›å€¼ï¼›æ— 
  115          ************************************************************************/
  116          void ADC_int(void)
  117          {
  118   1              adc_init(Left_ADC_Pin, ADC_SYSclk_DIV_2);         // åˆå§‹åŒ–P0.0ä¸ºADCåŠŸèƒ½
  119   1              adc_init(LeftXie_ADC_Pin, ADC_SYSclk_DIV_2);  // åˆå§‹åŒ–P0.1ä¸ºADCåŠŸèƒ½
  120   1              adc_init(RightXie_ADC_Pin, ADC_SYSclk_DIV_2); // åˆå§‹åŒ–P0.5ä¸ºADCåŠŸèƒ½
  121   1              adc_init(Right_ADC_Pin, ADC_SYSclk_DIV_2);        // åˆå§‹åŒ–P0.6ä¸ºADCåŠŸèƒ½
  122   1      
  123   1              adc_init(Mid_ADC_Pin, ADC_SYSclk_DIV_2); // åˆå§‹åŒ–P1.5ä¸ºADCåŠŸèƒ½
C251 COMPILER V5.60.0,  ADC                                                                05/04/25  21:33:17  PAGE 3   

  124   1      }
  125          
  126          /***************************ä¸­å€¼æ»¤æ³¢å‡½æ•°*********************************
  127          å‡½æ•°ï¼šuint16 adc_mid(ADCN_enum adcn,ADCCH_enum ch)
  128          åŠŸèƒ½ï¼š 3æ¬¡ç”µæ„Ÿé‡‡å€¼è¿›è¡Œä¸­å€¼æ»¤æ³¢
  129          å‚æ•°ï¼š adcn        é€‰æ‹©ADCé€šé“       resolution      åˆ†è¾¨ç‡
  130          è¯´æ˜ï¼š 8ä½ADCè¾“å‡ºï¼Œ0~255ï¼ˆ2çš„8æ¬¡æ–¹ï¼‰ï¼Œ5vç”µå‹å¹³å‡åˆ†æˆ255ä»½ï¼Œåˆ†è¾¨ç‡ä¸º5/255=0.196
  131          è¿”å›å€¼ï¼›k(uint8)ä¸­é—´é‚£ä¸ªå€¼
  132          ************************************************************************/
  133          uint16 adc_mid(ADCN_enum adcn, ADCRES_enum ch)
  134          {
  135   1              uint16 i, j, k, tmp;
  136   1              i = adc_once(adcn, ch);
  137   1              j = adc_once(adcn, ch);
  138   1              k = adc_once(adcn, ch);
  139   1              if (i > j)
  140   1              {
  141   2                      tmp = i, i = j, j = tmp;
  142   2              }
  143   1              if (k > j)
  144   1              {
  145   2                      tmp = j;
  146   2              }
  147   1              else if (k > i)
  148   1              {
  149   2                      tmp = k;
  150   2              }
  151   1              else
  152   1              {
  153   2                      tmp = i;
  154   2              }
  155   1              return (tmp);
  156   1      }
  157          
  158          /***************************å‡å€¼æ»¤æ³¢å‡½æ•°****************************
  159          å‡½æ•°ï¼š  uint16 adc_ave(ADCN_enum adcn,ADCCH_enum ch,uint8 N)
  160          åŠŸèƒ½ï¼š  ä¸­å€¼æ»¤æ³¢åçš„5ä¸ªç”µæ„Ÿå€¼æ±‚å¹³å‡å€¼
  161          å‚æ•°ï¼š  adcn        é€‰æ‹©ADCé€šé“
  162          è¯´æ˜ï¼š  è¯¥å‡½æ•°è°ƒç”¨ä¸­å€¼æ»¤æ³¢å‡½æ•°ï¼Œå³ç”µæ„Ÿå€¼æ˜¯ä¸­ä½ç½®
  163          è¿”å›å€¼ï¼›tmp
  164          ç¤ºä¾‹ï¼š  adc_ave(ADC_P10, ADC_8BIT)-->ADCé€šé“ä¸ºP-10ï¼Œåˆ†è¾¨ç‡ä¸º8bit
  165          *******************************************************************/
  166          uint16 adc_ave(ADCN_enum adcn, ADCRES_enum ch, uint8 N)
  167          {
  168   1              uint32 tmp = 0;
  169   1              uint8 i;
  170   1              for (i = 0; i < N; i++)
  171   1              {
  172   2                      tmp += adc_mid(adcn, ch);
  173   2              }
  174   1              tmp = tmp / N;
  175   1              return (tmp);
  176   1      }
  177          /***************************ç”µæ„Ÿé‡‡å€¼************************************
  178          å‡½æ•°ï¼š  void ADC_Collect()
  179          åŠŸèƒ½ï¼š  ç”µæ„Ÿé‡‡å€¼
  180          å‚æ•°ï¼š  void
  181          è¯´æ˜ï¼š  8ä½ADCè¾“å‡ºï¼Œ0~255ï¼ˆ2çš„8æ¬¡æ–¹ï¼‰ï¼Œ5vç”µå‹å¹³å‡åˆ†æˆ255ä»½ï¼Œåˆ†è¾¨ç‡ä¸º5/255=0.196
  182          è¿”å›å€¼ï¼›void
  183          ***********************************************************************/
  184          void ADC_Collect()
  185          {
  186   1              adc_value[0] = adc_ave(Left_ADC_Pin, ADC_8BIT, 3);               // å·¦æ¨ªç”µæ„Ÿ
  187   1              adc_value[1] = adc_ave(LeftXie_ADC_Pin, ADC_8BIT, 3);    // å·¦ç«–ç”µæ„Ÿ
  188   1              adc_value[2] = adc_ave(RightXie_ADC_Pin, ADC_8BIT, 3);   // å³ç«–ç”µæ„Ÿ
  189   1              adc_value[3] = adc_ave(Right_ADC_Pin, ADC_8BIT, 3);              // å³æ¨ªç”µæ„Ÿ
C251 COMPILER V5.60.0,  ADC                                                                05/04/25  21:33:17  PAGE 4   

  190   1              adc_valueM = adc_ave(Mid_ADC_Pin, ADC_8BIT, 3) * 0.2246; // ç”µæºç”µå‹é‡‡é›†
  191   1      }
  192          /*********************************ç”µæ„Ÿé‡‡å€¼********************************
  193          å‡½æ•°ï¼š  void Data_current_analyze()
  194          åŠŸèƒ½ï¼š  ç”µæ„Ÿé‡‡å€¼åŸå§‹å€¼å½’ä¸€åŒ–ï¼ˆ0~100ï¼‰
  195          å‚æ•°ï¼š  void
  196          è¯´æ˜ï¼š  å½’ä¸€åŒ–å¤„ç†
  197          è¿”å›å€¼ï¼›void
  198          *************************************************************************/
  199          void Data_current_analyze()
  200          {
  201   1              uint8 i;
  202   1              for (i = 0; i < NM; i++)
  203   1              {
  204   2                      AD_V[i] = ((adc_value[i] - adc_min[i]) * 100) / (adc_max[i] - adc_min[i]);
  205   2                      if (AD_V[i] <= 0)
  206   2                      {
  207   3                              AD_V[i] = 0;
  208   3                      }
  209   2                      else if (AD_V[i] >= 100)
  210   2                      {
  211   3                              AD_V[i] = 100;
  212   3                      }
  213   2              }
  214   1              Left_Adc = AD_V[0];              // å·¦ç”µæ„Ÿæœ€ç»ˆå€¼
  215   1              Left_Shu_Adc = AD_V[1];  // å·¦ç«–ç”µæ„Ÿæœ€ç»ˆå€¼
  216   1              Right_Shu_Adc = AD_V[2]; // å³ç«–ç”µæ„Ÿæœ€ç»ˆå€¼
  217   1              Right_Adc = AD_V[3];     // å³ç”µæ„Ÿæœ€ç»ˆå€¼
  218   1      }
  219          
  220          /*********************************å·®æ¯”å’Œå‡½æ•°**********************************
  221          å‡½æ•°ï¼š  float Cha_bi_he(int16 data1, int16 data2,int16 x)
  222          åŠŸèƒ½ï¼š  å·®æ¯”å’Œæ±‚èµ›é“åå·®
  223          å‚æ•°ï¼š  int16 data1, int16 data2,int16 x
  224          è¯´æ˜ï¼š  å·®æ¯”å’Œæ±‚èµ›é“åå·®
  225          è¿”å›å€¼ï¼›result
  226          ****************************************************************************/
  227          float Cha_bi_he(int16 data1, int16 data2, int16 x)
  228          {
  229   1              float cha;
  230   1              float he;
  231   1              float result;
  232   1      
  233   1              cha = (data1) - (data2);
  234   1              he = data1 + data2 + 1;
  235   1              result = (cha * x) / (1.0 * he);
  236   1      
  237   1              return result;
  238   1      }
  239          // å·®æ¯”å’Œå·®
  240          float Cha_bi_he_cha(int16 data1, int16 data2, int16 data3, int16 data4, int16 x, int16 y)
  241          {
  242   1              float cha;
  243   1              float he;
  244   1              float cha1;
  245   1              float he1;
  246   1      
  247   1              float result;
  248   1      
  249   1              cha = (data1) - (data2);
  250   1              cha1 = (data3) - (data4);
  251   1      
  252   1              he = data1 + data2 + 1;
  253   1              he1 = data3 + data4 + 1;
  254   1      
  255   1              //    result = (cha*x)/(1.0*he);
C251 COMPILER V5.60.0,  ADC                                                                05/04/25  21:33:17  PAGE 5   

  256   1              result = ((cha * x) + (cha1 * y)) / ((1.0 * he) + (1.0 * he1));
  257   1              return result;
  258   1      }
  259          float Cha_x_bi_he(int16 data1, int16 data2, int16 data3, int16 data4) // å‘é‡å·®æ¯”å’Œ
  260          {
  261   1              float left_value;
  262   1              float right_value;
  263   1              float ad_sum;
  264   1              float ad_diff;
  265   1              float error_x;
  266   1              left_value = sqrt(data1 * data1 + data2 * data2);
  267   1      
  268   1              right_value = sqrt(data3 * data3 + data4 * data4);
  269   1      
  270   1              ad_sum = left_value + right_value + 1; // è®¡ç®—ç”µæ„Ÿä¹‹å’Œ
  271   1      
  272   1              // è®¡ç®—ç”µæ„Ÿä¹‹å·®
  273   1      
  274   1              ad_diff = (int16)right_value - left_value;
  275   1              error_x = ad_diff / ad_sum;
  276   1      
  277   1              return error_x;
  278   1      }
  279          /*****************************************å‡ºç•Œä¿æŠ¤å‡½æ•°*************************************
  280          å‡½æ•°ï¼š  void Out_protect()
  281          å‚æ•°ï¼š  æ— 
  282          è¯´æ˜ï¼š  é˜²æ­¢è½¦å†²å‡ºèµ›é“åæ’åä¸œè¥¿,æ£€æµ‹å‡ºèµ›é“åä¸­æ–­å¤±èƒ½ï¼Œç”µæœºåœè½¬ï¼Œæ”¾å›èµ›
             -é“ä¸­æ–­ä½¿èƒ½ç»§ç»­è·‘
  283          
  284          *æ³¨æ„ï¼šï¼ï¼ï¼å¹³æ—¶è°ƒè¯•æ—¶å¯ä»¥æ‰“å¼€ï¼ŒåŠ äº†é¿éšœå¤„ç†åéœ€è¦å…³é—­æ­¤å‡½æ•°ï¼Œä¸ç„¶æœ‰å
             -¯èƒ½æ— æ³•å®ç°é¿éšœåŠŸèƒ½ï¼ï¼ï¼
  285          è¿”å›å€¼ï¼šæ— 
  286          ******************************************************************************************/
  287          void Out_protect(void)
  288          {
  289   1              if ((Left_Adc < OUTSIDE) && (Right_Adc < OUTSIDE) && (Left_Shu_Adc < OUTSIDE) && (Right_Shu_Adc < OUTSID
             -E))
  290   1              {
  291   2                      testflag = 404;
  292   2              }
  293   1      }
  294          
  295          /*************************************ç¯å²›è¾…åŠ©å‡½æ•°*************************************
  296          å‡½æ•°ï¼š  void Annulus_assist(void)
  297          å‚æ•°ï¼š  æ— 
  298          è¯´æ˜ï¼š  è¿‡ç¯å²›ä¸‰è§’åŒºç§¯åˆ†ï¼Œè¿›ç¯ç§¯åˆ†ï¼Œå‡ºç¯ç§¯åˆ†ç­‰
  299          
  300          *æ³¨æ„ï¼š ç§¯åˆ†å€¼ä¼šä¼šéšé‡‡æ ·æ—¶é—´çš„ä¸åŒè€Œæ”¹å˜ï¼Œéœ€è¦è‡ªå·±ç”¨æ‰‹æ¨è½¦å»æµ‹é‡ç”¨å±å¹•æ
             -˜¾ç¤ºçœ‹å¹¶è®°å½•å»ä¿®æ”¹
  301          è¿”å›å€¼ï¼šæ— 
  302          ******************************************************************************************/
  303          void Annulus_assist(void)
  304          {
  305   1              if (road_type.annulus == 1 && road_type.in_annulus_right == 0) //&&road_type.in_annulus_left==0
  306   1              {
  307   2                      annulus_s += fabs(last_speed) * 1;
  308   2              }
  309   1              if (road_type.in_annulus_right == 1) // road_type.in_annulus_left==1 ||                 && road_type.on_
             -annulus_left==0ï¼ˆå¤–ï¼‰&& road_type.on_annulus_right==0
  310   1              {
  311   2                      annulus_z += fabs(GORY_Z);
  312   2                      annulus_s2 += fabs(last_speed) * 1; // æ ¹æ®ç§¯åˆ†è·ç¦»å’Œç¼–ç å™¨çº¿å€¼æ›´æ”¹ï¼ˆ0.1ï¼‰
  313   2              }
  314   1              if (road_type.on_annulus_right == 1) // road_type.in_annulus_left==1 ||                 && road_type.on_
             -annulus_left==0ï¼ˆå¤–ï¼‰&& road_type.on_annulus_right==0
  315   1              {
C251 COMPILER V5.60.0,  ADC                                                                05/04/25  21:33:17  PAGE 6   

  316   2                      //        annulus_z += fabs(GORY_Z);
  317   2                      annulus_s3 += fabs(last_speed) * 1; // æ ¹æ®ç§¯åˆ†è·ç¦»å’Œç¼–ç å™¨çº¿å€¼æ›´æ”¹ï¼ˆ0.1ï¼‰
  318   2              }
  319   1              if (road_type.out_annulus == 1)
  320   1              {
  321   2                      annulus_t = fabs(last_speed) * 1;
  322   2                      //                    annulus_t=annulus_t+5;
  323   2              }
  324   1              // å‡ºç¯åç›´èµ°é˜¶æ®µç§¯åˆ†
  325   1              if (road_type.post_annulus == 1)
  326   1              {
  327   2                      annulus_post += fabs(last_speed) * 1;
  328   2              }
  329   1      }
  330          
  331          uint8 obstacle_number = 0;
  332          /*************************************é¿éšœæ£€æµ‹å‡½æ•°*************************************
  333          å‡½æ•°ï¼š  void obstacle_avoidance(void)
  334          å‚æ•°ï¼š  æ— 
  335          è¯´æ˜ï¼š  TFOé¿éšœæ¨¡å—æ£€æµ‹ï¼Œä½¿ç”¨è½¯ä»¶æ¨¡æ‹ŸIICé€šä¿¡ï¼Œç†è®ºä¸Šä»»ä½•å¼•è„šéƒ½å¯ä»¥ä½¿ç”¨ï¼Œä
             -½†æ˜¯è¦æ³¨æ„ä¸èƒ½å¼•è„š
  336                          å¤ç”¨ã€‚
  337          *æ³¨æ„ï¼š TOFæ¨¡å—ç¦»éšœç¢ç‰©è¶Šè¿œæ•°å€¼è¶Šå¤§ï¼Œè¶Šè¿‘æ•°å€¼è¶Šå°
  338          è¿”å›å€¼ï¼šæ— 
  339          ******************************************************************************************/
  340          void obstacle_avoidance(void)
  341          {
  342   1              dl1a_get_distance(); // è·ç¦»æµ‹é‡
  343   1              //      if(dl1a_distance_mm<SET_DLLA_DISTANCE&&flag_obstacle==0&&(fabs(Current_Dir)<3)&&obstacle_number==0) /
             -/æµ‹é‡è·ç¦»å°äºè®¾å®šå€¼æ ‡å¿—ä½æˆç«‹
  344   1              //      if(dl1a_distance_mm<SET_DLLA_DISTANCE)
  345   1              if (dl1a_distance_mm < SET_DLLA_DISTANCE && flag_obstacle == 0 && (fabs(Current_Dir) < 3)) // æµ‹é‡è·ç
             -¦»å°äºè®¾å®šå€¼æ ‡å¿—ä½æˆç«‹
  346   1              {
  347   2      
  348   2                      flag_obstacle = 0; // æ­£å¸¸åº”è¯¥æ˜¯ç­‰äº1å› ä¸ºç›®å‰20å±Šæ²¡æœ‰é¿éšœè¿™ä¸ªå…ƒç´ æ‰€ä»¥ä¸ä½¿ç”¨
  349   2                                                         //           obstacle_number++;//é¿éšœåªåˆ¤æ–­ä¸€æ¬¡ï¼Œå‘è½¦æ—¶é€šè¿‡æ‹¨ç å¼€å…³é€‰æ‹©å‡ºåº“æ–¹å‘å…ˆ
             -èµ°é¿éšœï¼Œåªåœ¨ç›´é“åˆ¤æ–­é¿éšœï¼Œå‡å°è¯¯åˆ¤
  350   2              }
  351   1      }
  352          /*************************************åˆ†æ®µP*************************************
  353          å‡½æ•°ï¼š  void obstacle_avoidance(void)
  354          å‚æ•°ï¼š  æ— 
  355          è¯´æ˜ï¼š  TFOé¿éšœæ¨¡å—æ£€æµ‹ï¼Œä½¿ç”¨è½¯ä»¶æ¨¡æ‹ŸIICé€šä¿¡ï¼Œç†è®ºä¸Šä»»ä½•å¼•è„šéƒ½å¯ä»¥ä½¿ç”¨ï¼Œä
             -½†æ˜¯è¦æ³¨æ„ä¸èƒ½å¼•è„š
  356                          å¤ç”¨ã€‚
  357          *æ³¨æ„ï¼š TOFæ¨¡å—ç¦»éšœç¢ç‰©è¶Šè¿œæ•°å€¼è¶Šå¤§ï¼Œè¶Šè¿‘æ•°å€¼è¶Šå°
  358          è¿”å›å€¼ï¼šæ— 
  359          ******************************************************************************************/
  360          void subsection_p(void)
  361          {
  362   1      }
  363          /*************************************é¿éšœè¾…åŠ©å‡½æ•°*************************************
  364          å‡½æ•°ï¼š  void Annulus_assist(void)
  365          å‚æ•°ï¼š  æ— 
  366          è¯´æ˜ï¼š  è¿‡ç¯å²›ä¸‰è§’åŒºç§¯åˆ†ï¼Œè¿›ç¯ç§¯åˆ†ï¼Œå‡ºç¯ç§¯åˆ†ç­‰
  367          
  368          *æ³¨æ„ï¼š ç§¯åˆ†å€¼ä¼šä¼šéšé‡‡æ ·æ—¶é—´çš„ä¸åŒè€Œæ”¹å˜ï¼Œéœ€è¦è‡ªå·±ç”¨æ‰‹æ¨è½¦å»æµ‹é‡ç”¨å±å¹•æ
             -˜¾ç¤ºçœ‹å¹¶è®°å½•å»ä¿®æ”¹
  369          ******************************************************************************************/
  370          void Obstacle_assist(void)
  371          {
  372   1              if (flag_obstacle == 1)
  373   1              {
  374   2                      obstacle_annulus_z1 += fabs(GORY_Z) * 0.1;
  375   2                      obstacle_annulus_s1 += fabs(real_speed) * 0.1;
C251 COMPILER V5.60.0,  ADC                                                                05/04/25  21:33:17  PAGE 7   

  376   2              }
  377   1              if (obstacle_switch_1 == 1 && flag_obstacle == 1)
  378   1              {
  379   2                      obstacle_annulus_z2 += fabs(GORY_Z) * 0.1;
  380   2                      obstacle_annulus_s2 += fabs(real_speed) * 0.1;
  381   2              }
  382   1              if (obstacle_switch_2 == 1 && obstacle_switch_1 == 1 && flag_obstacle == 1)
  383   1              {
  384   2                      obstacle_annulus_z3 += fabs(GORY_Z) * 0.1;
  385   2                      obstacle_annulus_s3 += fabs(real_speed) * 0.1;
  386   2              }
  387   1      }
  388          uint8 Annulus_selection = 0;
  389          /*****************************************ç¯å²›å¤„ç†***************************************
  390          å‡½æ•°ï¼š  void Annulus_handle(void)
  391          å‚æ•°ï¼š  æ— 
  392          è¯´æ˜ï¼š  ç¯å²›å¤„ç†å‡½æ•°
  393          
  394          *æ³¨æ„ï¼šç”¨ä¸¤ä¸ªç«–ç”µæ„Ÿå¼•å¯¼è¿›ç¯
  395          è¿”å›å€¼ï¼šæ— 
  396          ******************************************************************************************/
  397          void Annulus_handle(void)
  398          {
  399   1              // å¦‚æœå¤„äºå‡ºç¯åç›´èµ°é˜¶æ®µï¼Œåˆ™æ£€æµ‹æ˜¯å¦ç»“æŸè¯¥é˜¶æ®µ
  400   1              if (road_type.post_annulus == 1)
  401   1              {
  402   2                      if (annulus_post > 900) // å‡ºç¯åç›´èµ°ç§¯åˆ†
  403   2                      {
  404   3                              road_type.annulus = 0;
  405   3                              road_type.post_annulus = 0;
  406   3                              annulus_post = 0;
  407   3                              annulus_s = 0;
  408   3                              annulus_s2 = 0;
  409   3                              annulus_s3 = 0;
  410   3                              // Speed_pwm_left = Last_speed_pwm_left;
  411   3                              // Speed_pwm_right = Last_speed_pwm_right;
  412   3                              BUZZ_OFF;
  413   3                      }
  414   2                      return; // åœ¨ç›´èµ°é˜¶æ®µä¸å…è®¸è¿›å…¥ç¯å²›ï¼Œç›´æ¥è¿”å›
  415   2              }
  416   1      
  417   1              // ç¯å²›å…¥å£æ£€æµ‹
  418   1              if ((Left_Adc + Right_Adc) > IN_ANNULUS_H_LIMIT && road_type.annulus == 0 && road_type.out_annulus == 0)
             - //&&Annulus_selection==0
  419   1              {
  420   2                      road_type.annulus = 1;
  421   2                      //                      aim_speed        = 40;
  422   2                      P52 = 0;
  423   2                      BUZZ_ON;
  424   2              }
  425   1              // å·¦ç¯è¿›ç¯åˆ¤æ–­
  426   1              //              if(annulus_s > DISTANCE_ANNULUS_S&&road_type.annulus==1&&road_type.in_annulus_left==0&&(Left_Shu_Adc
             ->20))
  427   1              //              {
  428   1              //                      road_type.in_annulus_left = 1;
  429   1              //                      BUZZ_ON;
  430   1              //                      P52                      = 0;
  431   1              //              }
  432   1              // å³ç¯è¿›ç¯åˆ¤æ–­
  433   1              if (annulus_s > DISTANCE_ANNULUS_S && road_type.in_annulus_right == 0 && road_type.annulus == 1) //&&(Ri
             -ght_Adc>20)
  434   1              {
  435   2                      road_type.in_annulus_right = 1;
  436   2                      BUZZ_ON;
  437   2      
  438   2                      //                              while(1)//å…¥ç¯èŠ‚ç‚¹1
C251 COMPILER V5.60.0,  ADC                                                                05/04/25  21:33:17  PAGE 8   

  439   2                      //                                      {
  440   2                      //                                              go_motor(0,0);
  441   2                      //                                      }
  442   2              }
  443   1              // å·¦ç¯å¤„ç†
  444   1              //              if(road_type.in_annulus_left == 1 && annulus_z > DISTANCE_ANNULUS_Z && annulus_s2>350 &&road_type.on
             -_annulus_left==0)
  445   1              //              {
  446   1              //
  447   1              //                        road_type.on_annulus_left = 1;
  448   1              //                              BUZZ_ON;
  449   1              //                        P52                      = 1;
  450   1              //              }
  451   1              // å³ç¯å¤„ç†
  452   1              if (road_type.in_annulus_right == 1 && annulus_s2 > 1200) //
  453   1              {
  454   2                      road_type.on_annulus_right = 1;
  455   2                      BUZZ_ON;
  456   2                      //                        P52                      = 1;
  457   2                      //                      annulus_s2=0;
  458   2                      //                              while(1)//æ‰“è§’èŠ‚ç‚¹3
  459   2                      //                                      {
  460   2                      //                                              go_motor(0,0);
  461   2                      //                                      }
  462   2              }
  463   1              if (road_type.on_annulus_right == 1 && annulus_s3 > 200 && (Left_Adc + Right_Adc) > OUT_ANNULUS_S_LIMIT 
             -&& road_type.out_annulus == 0) // +Right_Shu_Adc+Left_Shu_Adc
  464   1              {
  465   2                      BUZZ_ON;
  466   2                      road_type.out_annulus = 1;
  467   2                      // testflag = 7;
  468   2                      annulus_s = 0;
  469   2                      annulus_z = 0;
  470   2                      annulus_s2 = 0;
  471   2                      annulus_s3 = 0; // æ¸…é›¶annulus_s3é˜²æ­¢å½±å“ä¸‹ä¸€æ¬¡ç¯å²›åˆ¤æ–­
  472   2                      P52 = 1;
  473   2              }
  474   1              // å‡ºç¯å¤„ç†
  475   1              if (annulus_s3 > DISTANCE_ANNULUS_T && road_type.out_annulus == 1)
  476   1              {
  477   2                      road_type.in_annulus_left = 0;
  478   2                      road_type.in_annulus_right = 0;
  479   2                      road_type.on_annulus_left = 0;
  480   2                      road_type.on_annulus_right = 0;
  481   2                      road_type.out_annulus = 0;
  482   2                      annulus_t = 0;
  483   2      
  484   2                      // å¯åŠ¨å‡ºç¯åç›´èµ°é˜¶æ®µ
  485   2                      road_type.post_annulus = 1;
  486   2                      annulus_post = 0; // åˆå§‹åŒ–å‡ºç¯åç›´èµ°ç§¯åˆ†
  487   2                      BUZZ_OFF;
  488   2                      //                                      while(1)//å‡ºç¯7
  489   2                      //                                      {
  490   2                      //                                              go_motor(0,0);
  491   2                      //                                      }
  492   2              }
  493   1      }
  494          /*************************æ ¹æ®èµ›é“ç±»å‹é€‰æ‹©ä¸åŒçš„æ–¹å‘åå·®è®¡ç®—æ–¹æ³•**********************
             -***
  495          å‡½æ•°ï¼š  int16 Direction_error(void)
  496          åŠŸèƒ½ï¼š  æ ¹æ®èµ›é“ç±»å‹é€‰æ‹©ä¸åŒçš„æ–¹å‘åå·®
  497          å‚æ•°ï¼š  æ— 
  498          è¯´æ˜ï¼š  æ ¹æ®èµ›é“ç±»å‹é€‰æ‹©ä¸åŒçš„æ–¹å‘åå·®
  499          è¿”å›å€¼ï¼šerror--è¿”å›èµ›é“åå·®
  500          ****************************************************************************************/
  501          float Direction_error(void)
C251 COMPILER V5.60.0,  ADC                                                                05/04/25  21:33:17  PAGE 9   

  502          {
  503   1              float error = 0;
  504   1      
  505   1              // ç¯å²›æ–¹å‘åå·®è®¡ç®—
  506   1              if (road_type.annulus == 1)
  507   1              {
  508   2                      // å‡†å¤‡å…¥ç¯å²›æ–¹å‘åå·®è®¡ç®—
  509   2                      //        if(road_type.annulus==1&&road_type.in_annulus_left==0 && road_type.in_annulus_right==0 && roa
             -d_type.on_annulus_left==0 && road_type.on_annulus_right==0 && road_type.out_annulus==0)
  510   2                      //                              {
  511   2                      //                                      error = Cha_x_bi_he(Left_Adc,Left_Shu_Adc,Right_Adc,Right_Shu_Adc)*20;
  512   2                      //        //å…¥å·¦ç¯å²›æ–¹å‘åå·®è®¡ç®—
  513   2                      //        if(road_type.in_annulus_left ==1 && road_type.on_annulus_left==0 )
  514   2                      //                              {
  515   2                      //                                  //error = Cha_x_bi_he(Left_Adc,Left_Shu_Adc,Right_Adc,Right_Shu_Adc)*20;
  516   2                      //                                        error = -15;
  517   2                      //                                      road_type.annulus=0;//å‡ºç¯å²›æ ‡å¿—ä½æ¸…é›¶
  518   2                      //                              }
  519   2                      // å…¥å³ç¯å²›æ–¹å‘åå·®è®¡ç®—
  520   2                      if (road_type.in_annulus_right == 1 && road_type.on_annulus_right == 0 && road_type.out_annulus == 0)
  521   2                      {
  522   3                              // error = Cha_x_bi_he(Left_Adc,Left_Shu_Adc,Right_Adc,Right_Shu_Adc)*20;                                        // error = 3;
  523   3                              error = 2.5; // é€»è¾‘ç›¸åä¸å¾ªè¿¹
  524   3      
  525   3                              //                              while(1)//æ‰“è§’èŠ‚ç‚¹2
  526   3                              //                                      {
  527   3                              //                                              go_motor(0,0);
  528   3                              //                                      }
  529   3                      }
  530   2                      // åœ¨ç¯å²›åå·®
  531   2                      if (road_type.on_annulus_right == 1)
  532   2                      {
  533   3                              // road_type.annulus = 0; // å…¥ç¯å²›æ ‡å¿—ä½æ¸…é›¶
  534   3                              road_type.in_annulus_right = 0;
  535   3                              //                                      error = Cha_x_bi_he(Left_Adc,Left_Shu_Adc,Right_Adc,Right_Shu_Adc)*20;
  536   3                              error = (Cha_bi_he(Right_Adc, Left_Adc, 20));
  537   3      
  538   3                              //                              while(1)//ç¯å†…å¾ªè¿¹èŠ‚ç‚¹4
  539   3                              //                                      {
  540   3                              //                                              go_motor(0,0);
  541   3                              //                                      }
  542   3                      }
  543   2                      // å‡ºç¯å²›æ–¹å‘åå·®è®¡ç®—
  544   2                      if (road_type.out_annulus == 1)
  545   2                      {
  546   3                              //                                  error = Cha_x_bi_he(Left_Adc,Left_Shu_Adc,Right_Adc,Right_Shu_Adc)*7;
  547   3                              error = 3;
  548   3                              //                                      error = Cha_bi_he(Right_Adc,Left_Adc,5);
  549   3                              // road_type.annulus = 0; // å‡ºç¯å²›æ ‡å¿—ä½æ¸…é›¶
  550   3                              //                              while(1)//å‡ºç¯èŠ‚ç‚¹6
  551   3                              //                                      {
  552   3                              //                                              go_motor(0,0);
  553   3                              //                                      }
  554   3                      }
  555   2                      if (road_type.post_annulus == 1)
  556   2                      {
  557   3                              error = 0;
  558   3                      }
  559   2              }
  560   1              // é¿éšœè¯¯å·®å¤„ç†
  561   1      
  562   1              else if (flag_obstacle == 1 && obstacle_number <= 1)
  563   1              {
  564   2                      P52 = 0;
  565   2                      error = 6;
  566   2      
C251 COMPILER V5.60.0,  ADC                                                                05/04/25  21:33:17  PAGE 10  

  567   2                      // go_motor(0,2000);
  568   2                      if (obstacle_annulus_s1 > 400) //
  569   2                      {
  570   3      
  571   3                              obstacle_switch_1 = 1;
  572   3                              error = -8;
  573   3                              //                              while(1)
  574   3                              //                                      {
  575   3                              //                                        go_motor(0,0);
  576   3                              //                                      }
  577   3                      }
  578   2                      if (obstacle_annulus_s2 > 400)
  579   2                      {
  580   3                              obstacle_switch_2 = 1;
  581   3                              error = -3.5;
  582   3                      }
  583   2                      if (obstacle_annulus_s3 > 150) // obstacle_annulus_z3>100&&     &&(Right_Adc+Left_Adc>30)
  584   2                      {
  585   3                              //                                      error = 3;
  586   3      
  587   3                              //                                      while(1)
  588   3                              //                                      {
  589   3                              //                                        go_motor(0,0);   //&&obstacle_annulus_s2>400
  590   3                              //
  591   3                              //                                      }
  592   3                              obstacle_switch_1 = 0;
  593   3                              obstacle_switch_2 = 0;
  594   3                              obstacle_annulus_z1 = 0;
  595   3                              obstacle_annulus_z2 = 0;
  596   3                              obstacle_annulus_z3 = 0;
  597   3                              obstacle_annulus_s1 = 0;
  598   3                              obstacle_annulus_s2 = 0;
  599   3                              obstacle_annulus_s3 = 0;
  600   3                              BUZZ_OFF;
  601   3      
  602   3                              P52 = 1;
  603   3                              flag_obstacle = 0; // é¿éšœç»“æŸæ ‡å¿—ä½æ¸…é›¶
  604   3                              obstacle_number++; // é¿éšœåªåˆ¤æ–­ä¸€æ¬¡ï¼Œå‘è½¦æ—¶é€šè¿‡æ‹¨ç å¼€å…³é€‰æ‹©å‡ºåº“æ–¹å‘å…ˆèµ°é¿éš
             -œï¼Œåªåœ¨ç›´é“åˆ¤æ–­é¿éšœï¼Œå‡å°è¯¯åˆ¤
  605   3                                                                 //                                   while(1)
  606   3                                                                 //                                   {
  607   3                                                                 //                                           go_motor(0,0);
  608   3                                                                 //                                   }
  609   3                      }
  610   2              }
  611   1              else
  612   1              {
  613   2      
  614   2                      //              aim_speed = ZxjsWdjs(Cha_x_bi_he(Left_Adc,Left_Shu_Adc,Right_Adc,Right_Shu_Adc),400)+100;
  615   2                      error = Cha_x_bi_he(Left_Adc, Left_Shu_Adc * 1, Right_Adc, Right_Shu_Adc * 1) * 20; // å±å¹•æ˜¾ç¤ºçš„è
             -µ›é“åå·®å€¼
  616   2                      errors = Cha_x_bi_he(Left_Adc, Left_Shu_Adc, Right_Adc, Right_Shu_Adc);                         // å½’ä¸€åŒ–çš„æ ‡å‡†èµ›é“å
             -å·®å€¼
  617   2      
  618   2                      //                      errorh=1.0f/exp(errors*errors);                                                                                         //å‡é€Ÿå‡½æ•°
  619   2                      //                      aim_speedb=aim_speed*errorh;                                                                                            //åŠ¨æ€æœŸæœ›é€Ÿåº¦ï¼ˆç›´é“æ— è¡°å‡å¼¯é“è¡°å‡ï¼‰
  620   2                      aim_speedb = aim_speed; // åŠ¨æ€æœŸæœ›é€Ÿåº¦ï¼ˆç›´é“æ— è¡°å‡å¼¯é“è¡°å‡ï¼‰
  621   2                                                                      //                      if(Left_Adc==0&&Left_Shu_Adc==0&&Right_Adc==0&&Right_Shu_Adc==0)
  622   2                                                                      //                      {
  623   2                                                                      //                      aim_speedb = -10;                                                                                                                       //ä¸¢çº¿å€’è½¦
  624   2                                                                      //                      }
  625   2      
  626   2                      //      }
  627   2              }
  628   1              return error;
  629   1      }
C251 COMPILER V5.60.0,  ADC                                                                05/04/25  21:33:17  PAGE 11  

  630          
  631          /**********************************ç”µç£æ‰€æœ‰æ€»å¤„ç†***************************************
  632          å‡½æ•°ï¼š  void Get_deviation(void)
  633          åŠŸèƒ½ï¼š  ç”µç£æ‰€æœ‰æ€»å¤„ç†
  634          å‚æ•°ï¼š  æ— 
  635          è¯´æ˜ï¼š  æ”¾ä¸­æ–­è°ƒç”¨æ­¤å‡½æ•°å³å¯
  636          è¿”å›å€¼ï¼šæ— 
  637          ****************************************************************************************/
  638          void Get_deviation(void)
  639          {
  640   1      
  641   1              ADC_Collect();                  // ç”µæ„ŸåŸå§‹å€¼é‡‡å€¼
  642   1              Data_current_analyze(); // ç”µæ„Ÿå€¼å½’ä¸€åŒ–å‡½æ•°
  643   1              Annulus_handle();               // ç¯å²›å¤„ç†
  644   1              Annulus_assist();               // ç¯å²›è¾…åŠ©å‡½æ•°
  645   1              obstacle_avoidance();   // éšœç¢ç‰©æ£€æµ‹
  646   1              Obstacle_assist();
  647   1              Current_Dir = Direction_error(); // è·å¾—èµ›é“åå·®
  648   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      1904     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =       231         20
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =       341     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
